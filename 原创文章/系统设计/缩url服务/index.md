https://www.educative.io/courses/grokking-the-system-design-interview/m2ygV4E81AR

1. 提问以获取使用场景和约束

2. 为什么需要这个系统,意义是什么?

3. 系统功能需求?
   输入 url,输出一个足够短的,容易记忆,输入,拷贝的 url 给其他系统或用户使用.
   新 url 访问后需要重定向回原本的地址.
   用户可以自定义短 url 地址.
   一段时间后短 url 会默认过期,用户可以自定义过期时间

4. 系统性能需求?
   系统必须高可用,因为如果你的短链接失效,意味着原服务定向不到.
   重定向的延迟必须低.
   短链接必须不可预测(不好猜出来)

5. 读写比率,qps,带宽,内存,硬盘估算(读和写)

   提问:
   系统流量(多少人使用,产生多少数据)?
   读写比率?
   存储保持时间?

   1. 读写比率是多少?
      **100 读:1 写**

      写就是生成新 url
      读就是短 url 重定向

   2. 系统流量(qps)是多少?

      **每月有 5 亿个新 url 生成.**

      那么写的 qps 是:`5 * 100000000/30 * 24 * 3600 ~= 200qps`

      读的 qps 是: `200qps * 100 = 2万qps`

   3. 估算每个 URL 大小

      `500字节`

   4. 带宽需求空间

      写: `200/s * 500 = 200 * 500 / 1024 = 100kb/s`
      读: `20k/s * 500 = 10mb/s`

   5. 内存需求空间

      给读加缓存:根据 28 原则: `20%的url会产生80%的流量`.所以我们缓存`20%的url`即可.

      `20kqps * 24时 * 3600秒 * 500字节 * 20% = 170GB`

   6. 存储需求空间

      **每一个短 url 存储 5 年**

      `5 亿 * 12 月 * 5 年 * 500字节 ~= 15TB`

6. 子系统设计

   是否可以将服务模块化,拆分出来

   在这里可以将生成 url 字符串拆成独立的服务.

7. 核心(模块)设计

   1. api 设计

      **restful vs soap**

      restful api

      输入参数:
      开发秘钥
      原始地址
      可选地址
      可选过期时间

      输出参数:成功的缩略后 url,失败显示错误码

   2. 如何避免并发(极值)造成的问题?

      比如这里有可能有恶意用户刷接口占用所有 url,应对方法是根据用户秘要,
      限制用户的产生数量和做一个时间的限制,比如 1 分钟内最多产生 1 个缩略 url.

8. 数据库设计

   1. 观察需求
      1. 我们需要存储数十亿条记录。
      2. 我们存储的每个对象都很小（小于 1K）。
      3. 除了存储哪个用户创建了 URL 之外，记录之间没有关系。
      4. 以读为主
   2. 使用哪种数据库?

      sql vs noSql

   3. 表设计

   4. 分区优化

      进行分区,减少表的大小,增加查找效率.

9. 详细设计和算法

   1. 哪种算法或设计
      如何生成秘要

      1. 实时把 url 缩短
         1. 使用 md5 生成 hash
         2. 取 hash 的前 6 位
         3. 如果重复,再次生成
      2. 分离出生成秘钥服务,预先生成,使用时取一个分配使用
         1. 定时任务或队列生成不重复秘要保存在数据库里
         2. 需要保证多服务器并发请求时,返回不同秘要

   2. 并发可能造成的问题?
      可能多个服务请求秘要服务,需要弄一个线程安全代码或上锁.

10. 防止单点故障

    入口负载均衡集群,然后定位到多个 web 服务,缓存, 主从结构数据库

    多地部署防止物理损坏或断网.

11. 缓存

    1. 选型 memcached(轻量) vs Redis(重量)

    2. 缓存多少量?
       每日的 20%流量
    3. 缓存策略
       LRU
    4. 优化
       复制缓存服务器来分配负载

12. 负载均衡

    1. 在哪儿部署
       1. client 和 web 服务之前(dns 服务器之后)
       2. web 服务和缓存服务之间
       3. web 服务和数据库之前
    2. 负载均衡策略
       1. 轮询
       2. url_hash
       3. ip_hash
       4. 权重
       5. least_conn(给连接少的)
       6. fair(给响应快的)

13. 数据清理

    1. 懒清理 - 发现失效时清理
    2. 定时任务 - 在负载低的时候清理

14. 统计数据

使用情况,用户信息

15. 安全性和权限管理
